<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <button class="btn-back" routerLink="/matches" title="Retour aux matchs">
      ← {{ 'chat.back' | translate }}
    </button>

    @if (match()) {
      <div class="match-info">
        <div class="match-photo-small">
          @if (match()!.otherUser.photo) {
            <img [src]="match()!.otherUser.photo" [alt]="match()!.otherUser.name" />
          } @else {
            <div class="no-photo-small">{{ match()!.otherUser.name.charAt(0) }}</div>
          }
        </div>
        <h2>{{ match()!.otherUser.name }}</h2>
      </div>
    }
  </div>

  <!-- Subscription Required Message -->
  @if (accessDenied() && requiresSubscription()) {
    <div class="subscription-required">
      <div class="subscription-prompt">
        <div class="lock-icon">🔒</div>
        <h2>{{ 'subscription.required' | translate }}</h2>
        <p [innerHTML]="'subscription.limitReached' | translate"></p>
        <p>{{ 'subscription.unlockUnlimited' | translate }}</p>
        <button class="btn-subscribe" (click)="goToSubscription()">
          💎 {{ 'subscription.viewPlans' | translate }}
        </button>
        <p class="note">{{ 'subscription.freeNote' | translate }}</p>
      </div>
    </div>
  }

  <!-- Messages List -->
  <div class="messages-list" [class.hidden]="accessDenied()">
    @if (isLoading()) {
      <div class="loading">
        <p>{{ 'chat.loading' | translate }}</p>
      </div>
    }

    @if (!isLoading() && messages().length === 0) {
      <div class="no-messages">
        <p>{{ 'chat.noMessages' | translate }}</p>
        <p class="hint">{{ 'chat.startConversation' | translate }}</p>
      </div>
    }

    @if (!isLoading() && messages().length > 0) {
      @for (message of messages(); track message.id) {
        <div class="message" [class.my-message]="isMyMessage(message)" [class.their-message]="!isMyMessage(message)">
          <div class="message-bubble">
            <p class="message-text">{{ message.message }}</p>
            <span class="message-time">{{ getTimeString(message.created_at) }}</span>
          </div>
        </div>
      }
    }
  </div>

  <!-- Message Input -->
  <div class="message-input-container" [class.hidden]="accessDenied()">
    @if (isTyping()) {
      <div class="typing-indicator">
        <span class="typing-text">{{ match()!.otherUser.name }} est en train d'écrire...</span>
      </div>
    }
    <div class="message-input-wrapper">
      <textarea
        #messageInput
        [(ngModel)]="newMessage"
        [placeholder]="'chat.typePlaceholder' | translate"
        (input)="onInput()"
        (keypress)="onKeyPress($event)"
        rows="1"
        [disabled]="isSending()"
      ></textarea>
      <button
        class="btn-send"
        (click)="sendMessage()"
        [disabled]="!newMessage().trim() || isSending()"
        [title]="'chat.send' | translate">
        {{ isSending() ? '⏳' : '📤' }}
      </button>
    </div>
  </div>
</div>
